# 6. Improving Functional Tests: Ensuring Isolation and Removing Voodoo Sleeps

## What is the power of `django.test`'s `LiveServerTestCase`?

1. It will automatically create a test database and start up a development server for the functional tests to run against. 

2. the test runner will find any files whose name begins with test.

3. instead of hardcoding the visit to localhost port 8000, LiveServerTestCase gives us an attribute called `live_server_url`.

functional_tests/tests.py (ch06l002)
```python
    def test_can_start_a_list_and_retrieve_it_later(self):
        # Edith has heard about a cool new online to-do app. She goes
        # to check out its homepage
        # self.browser.get('http://localhost:8000')
        self.browser.get(self.live_server_url)
```

4. We can also remove the if __name__ == '__main__' from the end if we want, since we’ll be using the Django test runner to launch the FT.


## how to Avoid "voodoo" sleeps

Whenever we need to wait for something to load, it’s always tempting to throw in a quick-and-dirty `time.sleep`. 

But the problem is that the length of time we wait is always a bit of a shot in the dark, either too short and vulnerable to spurious failures, or too long and it’ll slow down our test runs. 

Prefer a retry loop that polls our app and moves on as soon as possible.

```python
from selenium.common.exceptions import WebDriverException

MAX_WAIT = 10

    def wait_for_row_in_list_table(self, row_text):
        start_time = time.time()
        while True:
            try:
                table = self.browser.find_element_by_id('id_list_table')
                rows = table.find_elements_by_tag_name('tr')
                self.assertIn(row_text, [row.text for row in rows])
                return
            except (AssertionError, WebDriverException) as e:
                if time.time() - start_time > MAX_WAIT:
                    raise e
                time.sleep(0.5)
```

---
Last updated 2018-08-06 19:01:57

